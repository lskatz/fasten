on: push


name: benchmarking

jobs:
  build_and_test:
    name: Benchmark with python ${{ matrix.python-version }} and ${{matrix.os}}
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: ["ubuntu-latest"]
        python-version: ["3.7", "3.10"]
      fail-fast: false
    steps:
      - name: apt
        run:  |
          sudo apt-get install -y qtwayland5 tree
      - name: install hyperfine
        run:  |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.13.0/hyperfine-v1.13.0-x86_64-unknown-linux-gnu.tar.gz
          tar zxvf hyperfine-v1.13.0-x86_64-unknown-linux-gnu.tar.gz
          wget https://raw.githubusercontent.com/sharkdp/hyperfine/refs/tags/v1.19.0/scripts/plot_whisker.py -O hyperfine-v1.13.0-x86_64-unknown-linux-gnu/plot_whisker.py
          chmod -v +x hyperfine-v1.13.0-x86_64-unknown-linux-gnu/plot_whisker.py
          echo
          ls -Fd hyperfine-v1.13.0-x86_64-unknown-linux-gnu/*
          echo hyperfine-v1.13.0-x86_64-unknown-linux-gnu >> $GITHUB_PATH
      - uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: ${{ matrix.python-version }}
          mamba-version: "*"
          channels: bioconda,conda-forge,defaults
          activate-environment: benchmarking
      - name: Conda info
        shell: bash -l {0}
        run: conda info
      - name: create conda env
        shell: bash -l {0}
        run:  |
          conda info
          conda env list
          mamba install -n benchmarking seqkit seqtk matplotlib pyqt qtwayland
      - name: env
        shell: bash -l {0}
        run:  |
          which seqkit
          tree -d
      - uses: actions/checkout@v3
        with:
          path: fasten
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      #- uses: actions-rs/cargo@v1
      #  with:
      #    command: build
      #    args: --release --all-features
      - name: cargo build
        run: |
          cd fasten && cargo build --release
          tree -d
          echo "fasten/target/release" >> $GITHUB_PATH
      - name: benchmark
        shell: bash -l {0}
        env:
          QT_QPA_PLATFORM: offscreen
        run:  |
          export PATH=$PATH:fasten/target/release
          which fasten_clean
          #bash fasten/tests/10_benchmark.sh
          echo "Running benchmarks:"
          for i in fasten/tests/benchmark_*.sh; do echo "===$i==="; bash -x $i; done
      - name: save benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: fasten/tests/hyperfine


